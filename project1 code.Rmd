---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
date: "2026-02-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r setup}
library(readr)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(purrr)
library(scales)
library(readxl)

df <- read_excel("APM466_Bond_Data_Final(2).csv.xlsx")
View(df)
```


```{r setup2}
df <- df %>%
  mutate(
    Date = as.Date(Date),
    `Maturity Date` = as.Date(`Maturity Date`),
    Coupon = as.numeric(Coupon),
    `Closing Price` = as.numeric(`Closing Price`),
    TTM = as.numeric(`Maturity Date` - Date) / 365,
    cpn_rate = Coupon / 100
  )

all_dates <- sort(unique(df$Date))
bond_ids  <- sort(unique(df$ISIN))
```



```{r 4a}
pv_cc <- function(y, T, cpn_rate) {
  n_cpn <- floor(2 * T)
  times <- if (n_cpn >= 1) (1:n_cpn) / 2 else numeric(0)
  cpn_sa <- 100 * cpn_rate / 2

  pv_cpn <- sum(cpn_sa * exp(-y * times))
  pv_pri <- 100 * exp(-y * T)
  pv_cpn + pv_pri}

ytm_list <- vector("list", length(all_dates))
names(ytm_list) <- as.character(all_dates)

for (d in all_dates) {
  sub <- df[df$Date == d, c("Date","ISIN","Bond_Name","TTM","cpn_rate","Closing Price")]

  sub <- sub[sub$TTM > 0 & sub$TTM <= 5, ]

  sub <- sub[order(sub$TTM), ]

  sub$ytm <- NA_real_
  for (i in seq_len(nrow(sub))) {
    P <- sub$`Closing Price`[i]
    T <- sub$TTM[i]
    c <- sub$cpn_rate[i]

    f <- function(y) pv_cc(y, T, c) - P
    sub$ytm[i] <- uniroot(f, lower = -0.05, upper = 0.60)$root}
    
  ytm_list[[as.character(d)]] <- sub}

  ytm_panel <- dplyr::bind_rows(ytm_list)
```

```{r 4a plot}

ggplot(ytm_panel, aes(x = TTM, y = ytm, group = Date, color = factor(Date))) +
  geom_line(linewidth = 0.7, alpha = 0.85) +
  geom_point(size = 1.6, alpha = 0.85) +
  scale_y_continuous(labels = label_percent(accuracy = 0.01)) +
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 0.5)) +
  labs(
    title = "5-Year Yield Curve",
    x = "Time to Maturity (years)",
    y = "Yield to Maturity",
    color = "Date"
  ) +
  theme_minimal(base_size = 11) + theme(legend.position = "right")
```

```{r 4b}
spot_list <- vector("list", length(all_dates))
names(spot_list) <- as.character(all_dates)

for (d in all_dates) {

  sub <- df[df$Date == d, c("Date","ISIN","TTM","cpn_rate","Closing Price")]
  sub <- sub[sub$TTM > 0 & sub$TTM <= 5, ]
  sub <- sub[order(sub$TTM), ]

  n <- nrow(sub)
  sub$spot <- NA_real_

  for (i in 1:n) {

    P <- sub$`Closing Price`[i]
    T <- sub$TTM[i]
    c <- sub$cpn_rate[i]

    cpn_sa <- 100 * c / 2

    n_cpn <- floor(2 * T)
    times <- if (n_cpn >= 1) (1:n_cpn) / 2 else numeric(0)
    times_early <- times[times < T]

    pv_early <- 0
    if (length(times_early) > 0 && i > 1) {
      for (u in times_early) {
        j <- max(which(sub$TTM[1:(i-1)] <= u))
        pv_early <- pv_early + cpn_sa * exp(-sub$spot[j] * u)
      }
    }

    is_coupon_at_T <- abs(T - round(2*T)/2) < 1e-8
    CF_T <- 100 + if (is_coupon_at_T) cpn_sa else 0

    residual <- P - pv_early

    if (residual > 0 && T > 0) {
      sub$spot[i] <- (1 / T) * log(CF_T / residual)
    } else {
      sub$spot[i] <- NA_real_
    }
  }

  spot_list[[as.character(d)]] <- sub
}

spot_panel <- dplyr::bind_rows(spot_list)

```

```{r 4b plot}

ggplot(spot_panel, aes(x = TTM, y = spot, group = Date, color = factor(Date))) +
  geom_line(linewidth = 0.7, alpha = 0.85, na.rm = TRUE) +
  geom_point(size = 1.6, alpha = 0.85, na.rm = TRUE) +
  scale_y_continuous(labels = label_percent(accuracy = 0.01)) +
  scale_x_continuous(limits = c(0, 5), breaks = seq(0, 5, by = 0.5)) +
  labs(
    title = "5-Year Spot Curve",
    x = "Time to Maturity (years)",
    y = "Spot Rate",
    color = "Date"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "right",
    plot.title.position = "plot"
  )

```



```{r 4c}
# midpoints
t_grid <- 1:5
t_mid  <- (1:4) + 0.5

fwd_list <- vector("list", length(all_dates))
names(fwd_list) <- as.character(all_dates)

for (d in all_dates) {

  sub <- spot_panel[spot_panel$Date == d, c("Date", "TTM", "spot")]
  sub <- sub[!is.na(sub$spot) & sub$TTM > 0, ]
  sub <- sub[order(sub$TTM), ]

  s_on_grid <- approx(x = sub$TTM, y = sub$spot, xout = t_grid, rule = 2)$y

  fwd <- rep(NA_real_, 4)
  if (!any(is.na(s_on_grid))) {
    for (k in 1:4) {
      t1 <- t_grid[k]
      t2 <- t_grid[k + 1]
      s1 <- s_on_grid[k]
      s2 <- s_on_grid[k + 1]
      fwd[k] <- (s2 * t2 - s1 * t1) / (t2 - t1)
    }
  }

  fwd_list[[as.character(d)]] <- data.frame(
    Date = as.Date(d, origin = "1970-01-01"),
    TTM  = t_mid,
    fwd  = fwd
  )
}

# date fix
fwd_panel <- dplyr::bind_rows(fwd_list)

```

```{r 4c plot}
ggplot(fwd_panel, aes(x = TTM, y = fwd, group = Date, color = factor(Date))) +
  geom_line(linewidth = 0.7, alpha = 0.85, na.rm = TRUE) +
  geom_point(size = 1.6, alpha = 0.85, na.rm = TRUE) +
  scale_y_continuous(labels = label_percent(accuracy = 0.01)) +
  scale_x_continuous(limits = c(1, 5), breaks = seq(1, 5, by = 0.5)) +
  labs(
    title = "5-Year Forward Rate Curve",
    x = "Maturity",
    y = "Forward Rate",
    color = "Date"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "right",
    plot.title.position = "plot"
  )
    
```

```{r 5 and 6 yield cov and eigen}

m_grid <- 1:5
D <- sort(unique(ytm_panel$Date))

R <- matrix(NA_real_, nrow = length(D), ncol = length(m_grid))
colnames(R) <- paste0("r", m_grid)
rownames(R) <- as.character(D)

for (jj in seq_along(D)) {
  d <- D[jj]
  sub <- ytm_panel[ytm_panel$Date == d, c("TTM", "ytm")]
  sub <- sub[is.finite(sub$ytm) & sub$TTM > 0, ]
  sub <- sub[order(sub$TTM), ]

  if (nrow(sub) >= 2) {
    R[jj, ] <- approx(x = sub$TTM, y = sub$ytm, xout = m_grid, rule = 2)$y
  }}

X <- log(R[-1, , drop = FALSE] / R[-nrow(R), , drop = FALSE])
colnames(X) <- paste0("X", m_grid)

cov_yield <- cov(X, use = "complete.obs")
cov_yield

yield_eg <- eigen(cov_yield)

yield_eg$values
yield_eg$vectors


```
```{r 5 and 6 forward cov and eigen}
D <- sort(unique(spot_panel$Date))
t_grid <- 1:5
t1 <- 1
t2_vec <- 2:5

F <- matrix(NA_real_, nrow = length(D), ncol = 4)
rownames(F) <- as.character(D)
colnames(F) <- c("f(1,2)", "f(1,3)", "f(1,4)", "f(1,5)")

for (j in seq_along(D)) {
  d <- D[j]
  sub <- spot_panel[spot_panel$Date == d, c("TTM", "spot")]
  sub <- sub[!is.na(sub$spot) & sub$TTM > 0, ]
  sub <- sub[order(sub$TTM), ]

  if (nrow(sub) >= 2) {
    s_on_grid <- approx(x = sub$TTM, y = sub$spot, xout = t_grid, rule = 2)$y
    s1 <- s_on_grid[1]  # s(1)

    for (k in 1:4) {
      t2 <- t2_vec[k]
      s2 <- s_on_grid[t2]  # s(t2)
      F[j, k] <- (s2 * t2 - s1 * t1) / (t2 - t1)
    }
  }
}

X_fwd <- log(F[-1, , drop = FALSE] / F[-nrow(F), , drop = FALSE])

cov_fwd <- cov(X_fwd, use = "complete.obs")
cov_fwd

fwd_eg <- eigen(cov_fwd)

fwd_eg$values
fwd_eg$vectors
```

